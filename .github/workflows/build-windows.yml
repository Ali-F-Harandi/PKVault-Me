# Build PKVault WinForm EXE (frontend + .NET publish)
on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'        # release tags (optional)
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows EXE (win-x64)
    runs-on: windows-latest
    env:
      VITE_SERVER_URL: "http://localhost:5000"
      VITE_DESKTOP: "1"
    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install frontend deps & build
        working-directory: frontend
        shell: pwsh
        run: |
          npm ci
          # set env for Vite build (already provided in job env, but set explicitly for PowerShell)
          $env:VITE_SERVER_URL = '${{ env.VITE_SERVER_URL }}'
          $env:VITE_DESKTOP = '${{ env.VITE_DESKTOP }}'
          npm run build

      - name: Copy frontend build into WinForm wwwroot
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue PKVault.WinForm\wwwroot
          New-Item -ItemType Directory -Force PKVault.WinForm\wwwroot | Out-Null
          Copy-Item -Path frontend\dist\* -Destination PKVault.WinForm\wwwroot -Recurse -Force

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'  # match TargetFramework net9.0-windows

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-packages-${{ runner.os }}-$(Get-FileHash -Path "pkvault.sln" -Algorithm SHA256 | ForEach-Object { $_.Hash })
        shell: pwsh

      - name: Restore solution
        run: dotnet restore ./pkvault.sln

      - name: Publish WinForm single-file EXE
        run: |
          dotnet publish PKVault.WinForm/PKVault.WinForm.csproj \
            -c Release \
            -r win-x64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:PublishTrimmed=true \
            -o ./artifacts
      - name: List artifacts
        run: dir artifacts
        shell: pwsh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkvault-windows-exe
          path: artifacts/*.exe

      # Optional: create GitHub Release and upload EXE when this run is for a tag push
      - name: Find built EXE (for release upload)
        if: startsWith(github.ref, 'refs/tags/')
        id: find_exe
        shell: pwsh
        run: |
          $exe = (Get-ChildItem -Path artifacts -Filter *.exe -Recurse | Select-Object -First 1).FullName
          if (-not $exe) { Write-Error "No EXE found in artifacts"; exit 1 }
          echo "exe=$exe" >> $env:GITHUB_OUTPUT

      - name: Create GitHub release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}

      - name: Upload release asset (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_exe.outputs.exe }}
          asset_name: PKVault.exe
          asset_content_type: application/octet-stream
