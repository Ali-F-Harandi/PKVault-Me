name: Build PKVault Windows x64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Build version (optional)'
        required: false
        default: ''

  push:
    branches: [ main, master ]
    paths:
      - 'PKVault.Backend/**'
      - 'frontend/**'
      - 'PKVault.WinForm/**'
      - '.github/workflows/build-windows.yml'

  pull_request:
    branches: [ main, master ]
    paths:
      - 'PKVault.Backend/**'
      - 'frontend/**'
      - 'PKVault.WinForm/**'

jobs:
  build:
    runs-on: windows-latest

    env:
      DOTNET_VERSION: '9.0.x'
      NODE_VERSION: '20'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache PokeApi data
        uses: actions/cache@v4
        with:
          path: PKVault.Backend/pokeapi/data
          key: pokeapi-data-v1-${{ hashFiles('PKVault.Backend/pokeapi/**/*.cs') }}
          restore-keys: |
            pokeapi-data-v1-

      - name: Verify .NET SDK
        run: |
          dotnet --version
          dotnet --info

      - name: Verify Node.js and npm
        run: |
          node --version
          npm --version

      - name: Restore NuGet Packages
        run: dotnet restore pkvault.sln

      - name: Generate PokeApi Data
        run: |
          Write-Host "Generating PokeApi data..."
          cd PKVault.Backend
          dotnet run -p:Mode=gen-pokeapi
          cd ..

      - name: Install Frontend Dependencies
        run: |
          Write-Host "Installing frontend dependencies..."
          cd frontend
          npm install
          cd ..

      - name: Build Backend
        run: |
          Write-Host "Building backend..."
          dotnet build PKVault.Backend/PKVault.Backend.csproj -c Release

      - name: Generate Frontend SDK
        run: |
          Write-Host "Generating frontend SDK from backend..."
          Write-Host "Starting backend server..."

          # Build backend
          dotnet build PKVault.Backend/PKVault.Backend.csproj -c Release

          # Start backend in background
          cd PKVault.Backend
          $env:ASPNETCORE_URLS = "http://localhost:5000"
          Start-Process dotnet -ArgumentList "bin/Release/net9.0-windows/PKVault.Backend.dll","--urls","http://localhost:5000" -NoNewWindow -RedirectStandardOutput "backend.log" -RedirectStandardError "backend-error.log"
          $backendProcess = Get-Process dotnet | Where-Object {$_.Path -like "*PKVault.Backend*"} | Select-Object -First 1

          Write-Host "Backend process ID: $($backendProcess.Id)"

          # Wait for backend to be ready
          Write-Host "Waiting for backend to start..."
          Start-Sleep -Seconds 25

          # Check if backend is ready
          $ready = $false
          for ($i = 0; $i -lt 40; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:5000/swagger/v1/swagger.json" -UseBasicParsing -TimeoutSec 3 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                $ready = $true
                Write-Host "Backend is ready after $($i+1) attempts!"
                break
              }
            } catch {
              Write-Host "Attempt $($i+1)/40 - Waiting..."
              Start-Sleep -Seconds 2
            }
          }

          if (-not $ready) {
            Write-Error "Backend failed to start within 80 seconds"
            if (Test-Path backend-error.log) {
              Write-Host "Backend error log:"
              Get-Content backend-error.log | Select-Object -Last 20
            }
            Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }

          # Generate SDK
          Write-Host "Generating SDK with Orval..."
          cd ../frontend
          $env:NODE_TLS_REJECT_UNAUTHORIZED = "0"
          $env:VITE_SERVER_URL = "http://localhost:5000"
          npm run gen:sdk

          if ($LASTEXITCODE -ne 0) {
            Write-Error "SDK generation failed with exit code $LASTEXITCODE"
            Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }

          Write-Host "SDK generated successfully!"

          # Stop backend
          Write-Host "Stopping backend..."
          Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2

      - name: Build Frontend
        run: |
          Write-Host "Building frontend..."
          cd frontend
          $env:VITE_SERVER_URL = "http://localhost:5000"
          $env:VITE_DESKTOP = "1"
          npm run build

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "Checking frontend build output..."
          if (-not (Test-Path "dist")) {
            Write-Error "Frontend dist folder not found!"
            exit 1
          }

          Write-Host "Frontend build completed successfully"

      - name: Prepare WinForm wwwroot
        run: |
          Write-Host "Preparing WinForm wwwroot folder..."

          # Check if frontend dist exists
          if (-not (Test-Path "frontend/dist")) {
            Write-Error "Frontend dist folder not found. Frontend build may have failed."
            exit 1
          }

          # Remove old wwwroot
          Remove-Item -Path "PKVault.WinForm/wwwroot" -Recurse -Force -ErrorAction SilentlyContinue

          # Create new wwwroot
          New-Item -ItemType Directory -Path "PKVault.WinForm/wwwroot" -Force

          # Copy frontend build to wwwroot
          Write-Host "Copying frontend dist to wwwroot..."
          Copy-Item -Path "frontend/dist/*" -Destination "PKVault.WinForm/wwwroot" -Recurse -Force

          # Verify copy
          if (-not (Test-Path "PKVault.WinForm/wwwroot/index.html")) {
            Write-Error "wwwroot/index.html not found after copy!"
            exit 1
          }

          Write-Host "WinForm wwwroot prepared successfully"

      - name: Build WinForm for Windows x64
        run: |
          Write-Host "Building PKVault for Windows x64..."
          Write-Host "Configuration: Release"
          Write-Host "Runtime: win-x64"

          dotnet publish PKVault.WinForm/PKVault.WinForm.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:PackageVersion="${{ github.event.inputs.version || '1.3.5' }}"

          if ($LASTEXITCODE -ne 0) {
            Write-Error "WinForm build failed with exit code $LASTEXITCODE"
            exit 1
          }

          # Check if output exists
          $publishPath = "PKVault.WinForm/bin/Release/win-x64/publish"
          if (-not (Test-Path $publishPath)) {
            Write-Error "Publish path not found: $publishPath"
            Write-Host "Looking for alternative paths..."
            Get-ChildItem -Path "PKVault.WinForm/bin" -Recurse -Filter "*.exe" | Select-Object FullName
            exit 1
          }

          $exePath = Join-Path $publishPath "PKVault.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "PKVault.exe not found at $exePath"
            exit 1
          }

          Write-Host "WinForm build completed successfully"
          Write-Host "Output: $exePath"

      - name: Create Release Directory
        run: |
          Write-Host "Creating release directory..."
          New-Item -ItemType Directory -Path "release" -Force
          New-Item -ItemType Directory -Path "release/PKVault-Windows-x64" -Force

      - name: Copy Build Artifacts
        run: |
          Write-Host "Copying build artifacts..."
          $sourcePath = "PKVault.WinForm/bin/Release/win-x64/publish"
          $destPath = "release/PKVault-Windows-x64"

          if (-not (Test-Path $sourcePath)) {
            Write-Error "Source path not found: $sourcePath"
            exit 1
          }

          Copy-Item -Path "$sourcePath/*" -Destination $destPath -Recurse -Force

          if (-not (Test-Path "$destPath/PKVault.exe")) {
            Write-Error "PKVault.exe not found in release directory!"
            exit 1
          }

          Write-Host "Build artifacts copied successfully"

      - name: Create Build Info
        run: |
          $buildInfo = @"
          PKVault Windows x64 Build
          =========================
          Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          Platform: Windows x64
          Configuration: Release
          Target Framework: net9.0-windows
          Version: ${{ github.event.inputs.version || '1.3.5' }}

          Build completed successfully!

          Built by GitHub Actions
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          "@

          $buildInfo | Out-File -FilePath "release/PKVault-Windows-x64/BUILD_INFO.txt" -Encoding UTF8

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PKVault-Windows-x64-${{ github.run_number }}
          path: release/PKVault-Windows-x64/*
          retention-days: 90

      - name: Create Release Archive
        run: |
          Write-Host "Creating release archive..."
          Compress-Archive -Path "release/PKVault-Windows-x64/*" -DestinationPath "release/PKVault-Windows-x64.zip" -Force

      - name: Upload ZIP Archive
        uses: actions/upload-artifact@v4
        with:
          name: PKVault-Windows-x64-zip-${{ github.run_number }}
          path: release/PKVault-Windows-x64.zip
          retention-days: 90

      - name: Build Summary
        run: |
          Write-Host "::notice::Build completed successfully!"
          Write-Host "====================================="
          Write-Host "PKVault Windows x64 Build Summary"
          Write-Host "====================================="
          Write-Host "Platform: Windows x64"
          Write-Host "Runtime: win-x64"
          Write-Host "Configuration: Release"
          Write-Host "Version: ${{ github.event.inputs.version || '1.3.5' }}"
          Write-Host "Artifact: PKVault-Windows-x64-${{ github.run_number }}"
          Write-Host "====================================="
          Write-Host "Download your build from the Actions tab!"
